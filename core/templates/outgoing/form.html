{% extends "admin/base_site.html" %}
{% load static %}
{% block content %}
<!-- {% block bodyclass %}{{ block.super }} of-nosidebar{% endblock %} -->
<div id="outgoing-form-app" :class="{'of-dark': dark}" class="of-wrap container-fluid">

  {% url 'admin_home' as dash_url %}

    <!-- HEADER -->
    <div class="of-head">
      <div class="of-head-left">
        <h2 class="of-head-title">Karta Sai</h2>
        <div class="of-head-meta">
          <span class="of-dot"></span>
          <span id="of-now" class="of-subtle"></span>
        </div>
      </div>

      <div class="of-head-right">
        <button class="of-iconbtn of-theme" @click="dark = !dark" :title="dark ? 'Light mode' : 'Dark mode'">
          <!-- sun/moon -->
          <svg v-if="dark" width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z" stroke="currentColor" stroke-width="2"/>
            <path d="M12 1v2M12 21v2M4.22 4.22 5.64 5.64M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78 5.64 18.36M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <svg v-else width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M21 12.79A9 9 0 1 1 11.21 3c.2 0 .4.01.59.03A7 7 0 0 0 21 12.79Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <span class="of-vsep" aria-hidden="true"></span>

        <a class="btn of-btn-ghost" href="{% firstof back_url dash_url %}">Fila ba Dashboard</a>
      </div>
    </div>

  <!-- Form -->
  <form method="post" enctype="multipart/form-data" class="of-form" novalidate>
    {% csrf_token %}
    {{ form.non_field_errors }}

    <!-- Seksi: Draf & Template -->
    <div class="of-section">
      <div class="of-section-head">
        <div class="of-icopill of-c-blue">
          <svg viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
        </div>
        <div>
          <div class="of-title">Template & Status</div>
          <div class="of-desc">Hili formatu dokumentu, konjuntu estatus (opsionál).</div>
        </div>
      </div>

      <!-- template_type -->
      {% if form.template_type %}
      <div class="fi">
        <label class="fi-label" for="{{ form.template_type.id_for_label }}">
          <span class="fi-ico of-c-indigo">
            <svg viewBox="0 0 24 24"><path d="M4 7h16M4 12h12M4 17h8" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
          </span>
          {{ form.template_type.label }}{% if form.template_type.field.required %}<span class="req">*</span>{% endif %}
          <span class="chip" :data-variant="'B'" v-text="tplText"></span>
        </label>
        {{ form.template_type }}
        {% if form.template_type.errors %}<div class="fi-err">{{ form.template_type.errors|striptags }}</div>{% endif %}
      </div>
      {% endif %}

      <!-- status (jika form menyertakan) -->
      {% if form.status %}
      <div class="fi">
        <label class="fi-label" for="{{ form.status.id_for_label }}">
          <span class="fi-ico of-c-teal">
            <svg viewBox="0 0 24 24"><path d="M5 21V4l7 3 7-3v17" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
          </span>
          {{ form.status.label }}
          <span class="chip" :data-variant="statusChip.variant" v-text="statusChip.label"></span>
        </label>
        {{ form.status }}
        {% if form.status.errors %}<div class="fi-err">{{ form.status.errors|striptags }}</div>{% endif %}
      </div>
      {% endif %}
    </div>

    <!-- Seksi: Isi Surat -->
    <div class="of-section">
      <div class="of-section-head">
        <div class="of-icopill of-c-amber">
          <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8Z" stroke="white" stroke-width="2" fill="none"/><path d="M14 2v6h6" stroke="white" stroke-width="2" fill="none"/></svg>
        </div>
        <div>
          <div class="of-title">Konteúdu Dokumentu</div>
          <div class="of-desc">Títulu no konteúdu prinsipál.</div>
        </div>
      </div>

      <!-- subject -->
      {% if form.subject %}
      <div class="fi">
        <label class="fi-label" for="{{ form.subject.id_for_label }}">
          <span class="fi-ico of-c-pink">
            <svg viewBox="0 0 24 24"><path d="M4 7h16M4 12h12M4 17h8" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
          </span>
          {{ form.subject.label }}{% if form.subject.field.required %}<span class="req">*</span>{% endif %}
          <span class="fi-note" v-text="subjectCount + ' chars'"></span>
        </label>
        {{ form.subject }}
        {% if form.subject.errors %}<div class="fi-err">{{ form.subject.errors|striptags }}</div>{% endif %}
      </div>
      {% endif %}

      <!-- body -->
      {% if form.body %}
      <div class="fi">
        <label class="fi-label" for="{{ form.body.id_for_label }}">
          <span class="fi-ico of-c-violet">
            <svg viewBox="0 0 24 24"><path d="M4 6h16M4 10h16M4 14h10M4 18h8" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
          </span>
          {{ form.body.label }}{% if form.body.field.required %}<span class="req">*</span>{% endif %}
          <span class="fi-note">{{ bodyCount.chars }} chars • {{ bodyCount.words }} words</span>
        </label>
        {{ form.body }}
        {% if form.body.errors %}<div class="fi-err">{{ form.body.errors|striptags }}</div>{% endif %}
      </div>
      {% endif %}
    </div>

    <!-- Seksi: Lampiran & TTE -->
    <div class="of-section">
      <div class="of-section-head">
        <div class="of-icopill of-c-teal">
          <svg viewBox="0 0 24 24"><path d="M8 17l7-7a3 3 0 1 1 4 4l-8 8a5 5 0 0 1-7-7l9-9" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
        </div>
        <div>
          <div class="of-title">Aneksu</div>
          <div class="of-desc">Hili anexu sira no (opsionalmente) hasai PDF ne'ebé asina ona.</div>
        </div>
      </div>

      <!-- attachments (many2many) -->
      {% if form.attachments %}
      <div class="fi">
        <label class="fi-label" for="{{ form.attachments.id_for_label }}">
          <span class="fi-ico of-c-slate">
            <svg viewBox="0 0 24 24"><path d="M8 17l7-7a3 3 0 1 1 4 4l-8 8a5 5 0 0 1-7-7l9-9" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
          </span>
          {{ form.attachments.label }}
          <span class="fi-note" v-text="attachmentsCount"></span>
        </label>
        {{ form.attachments }}
        {% if form.attachments.errors %}<div class="fi-err">{{ form.attachments.errors|striptags }}</div>{% endif %}
      </div>
      {% endif %}

      <!-- signed_pdf (optional) -->
      {% if form.signed_pdf %}
      <div class="fi">
        <label class="fi-label" for="{{ form.signed_pdf.id_for_label }}">
          <span class="fi-ico of-c-green">
            <svg viewBox="0 0 24 24"><path d="M12 16V4M7 9l5-5 5 5M4 20h16" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
          </span>
          {{ form.signed_pdf.label }}
          <span class="fi-note" v-text="signedName || 'PDF ≤ 20MB'"></span>
        </label>

        <div class="dropbox" @dragover.prevent @drop.prevent="onDropPdf($event, '{{ form.signed_pdf.auto_id }}')" @click="focusRealInput('{{ form.signed_pdf.auto_id }}')">
          <div class="dropbox-ico">
            <svg viewBox="0 0 24 24"><path d="M12 16V4M7 9l5-5 5 5M4 20h16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
          </div>
          <div>Seret & lepas **PDF Asina** di sini atau klik untuk memilih</div>
        </div>
        <div class="hidden-file">{{ form.signed_pdf }}</div>
        {% if form.signed_pdf.errors %}<div class="fi-err">{{ form.signed_pdf.errors|striptags }}</div>{% endif %}
      </div>
      {% endif %}
    </div>

    <!-- (Opsional) Retensi -->
    {% if form.retention_class or form.retention_until %}
    <div class="of-section">
      <div class="of-section-head">
        <div class="of-icopill of-c-red">
          <svg viewBox="0 0 24 24"><path d="M12 8v8M8 12h8M4 6h16" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
        </div>
        <div>
          <div class="of-title">Retensi Arsip</div>
          <div class="of-desc">Informasi retensi dokumen (opsional).</div>
        </div>
      </div>

      <div class="fi-grid">
        {% if form.retention_class %}
        <div class="fi">
          <label class="fi-label" for="{{ form.retention_class.id_for_label }}">
            <span class="fi-ico of-c-purple">
              <svg viewBox="0 0 24 24"><path d="M20 12 12 4H6v6l8 8 6-6Z" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
            </span>
            {{ form.retention_class.label }}
          </label>
          {{ form.retention_class }}
          {% if form.retention_class.errors %}<div class="fi-err">{{ form.retention_class.errors|striptags }}</div>{% endif %}
        </div>
        {% endif %}

        {% if form.retention_until %}
        <div class="fi">
          <label class="fi-label" for="{{ form.retention_until.id_for_label }}">
            <span class="fi-ico of-c-amber">
              <svg viewBox="0 0 24 24"><path d="M8 2v3M16 2v3M3 9h18" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
            </span>
            {{ form.retention_until.label }}
          </label>
          <div class="fi-icon-input">
            {{ form.retention_until }}
            <span class="fi-input-ico">
              <svg viewBox="0 0 24 24"><path d="M8 2v3M16 2v3M3 9h18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
            </span>
          </div>
          {% if form.retention_until.errors %}<div class="fi-err">{{ form.retention_until.errors|striptags }}</div>{% endif %}
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <!-- Aksi -->
    <div class="of-actions">
      <button type="submit" class="btn of-btn-primary">
        <svg width="18" height="18" viewBox="0 0 24 24"><path d="M20 6 9 17l-5-5" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
        Salva
      </button>
      <button type="submit" name="_addanother" value="1" class="btn of-btn-info">Salva &amp; Aumenta</button>
      <button type="submit" name="_continue" value="1" class="btn of-btn-ghost">Salva &amp; Kontinua Edita</button>
      <a class="btn of-btn-ghost" href="{% firstof back_url dash_url %}">Kansela</a>
    </div>
  </form>
</div>

<!-- ================== STYLE (inline) ================== -->
<style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb; --ring:#93c5fd;
  --teal:#14b8a6; --amber:#f59e0b; --green:#22c55e; --blue:#3b82f6;
  --violet:#8b5cf6; --indigo:#6366f1; --pink:#ec4899; --slate:#94a3b8; --purple:#a855f7; --red:#ef4444;
}
.of-dark{ --bg:#0b1221; --card:#0f172a; --text:#e5edf8; --muted:#9ab0d1; --border:#1f2937; --ring:#3b82f6; }
.of-wrap{color:var(--text);}
.of-subtle{color:var(--muted)}
.of-dot{width:6px;height:6px;border-radius:50%;background:var(--ring);display:inline-block}
#of-now{opacity:.9}

.of-iconbtn{border:1px solid var(--border); background:transparent; color:var(--text); padding:8px 10px; border-radius:10px}
.of-iconbtn:hover{border-color:var(--ring)}

.of-btn-primary{background:var(--blue); color:#fff; border:none}
.of-btn-primary:hover{filter:brightness(0.95)}
.of-btn-info{background:#0ea5e9; color:#fff; border:none}
.of-btn-info:hover{filter:brightness(0.95)}
.of-btn-ghost{border:1px solid var(--border); background:transparent}
.of-btn-ghost:hover{background:rgba(2,6,23,.05)}

.of-form{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:18px; position:relative}
.of-section{padding:12px 6px; border-top:1px dashed var(--border)}
.of-section:first-child{border-top:none}
.of-section-head{display:flex; align-items:center; gap:12px; margin-bottom:8px}
.of-title{font-weight:700}
.of-desc{color:var(--muted); font-size:.95rem}
.of-icopill{display:grid; place-items:center; width:38px; height:38px; border-radius:12px; color:#fff}
.of-icopill svg{width:20px; height:20px}
.of-c-blue{background:linear-gradient(150deg, #60a5fa, #3b82f6)}
.of-c-teal{background:linear-gradient(150deg, #2dd4bf, #14b8a6)}
.of-c-indigo{background:linear-gradient(150deg, #818cf8, #6366f1)}
.of-c-amber{background:linear-gradient(150deg, #fbbf24, #f59e0b)}
.of-c-violet{background:linear-gradient(150deg, #a78bfa, #8b5cf6)}
.of-c-pink{background:linear-gradient(150deg, #f472b6, #ec4899)}
.of-c-green{background:linear-gradient(150deg, #34d399, #22c55e)}
.of-c-slate{background:linear-gradient(150deg, #cbd5e1, #94a3b8); color:#0f172a}
.of-c-purple{background:linear-gradient(150deg, #d8b4fe, #a855f7)}
.of-c-red{background:linear-gradient(150deg, #fca5a5, #ef4444)}

.of-head{
  display:flex; align-items:flex-start; justify-content:space-between;
  gap:24px; margin-bottom:16px;
}
.of-head-left{ display:flex; flex-direction:column; }
.of-head-title{ margin:0; line-height:1.2; }
.of-head-meta{ display:flex; align-items:center; gap:8px; margin-top:4px; }

.of-head-right{ display:flex; align-items:center; gap:18px; }
.of-theme{ flex:0 0 auto; }
.of-vsep{ width:1px; height:32px; background:var(--border); border-radius:1px; }

@media (max-width: 768px){
  .of-head{ flex-direction:column; gap:10px; }
  .of-vsep{ display:none; }
}

.fi{margin:10px 0}
.fi-grid{display:grid; grid-template-columns: 1fr 1fr; gap:14px}
@media (max-width: 992px){ .fi-grid{grid-template-columns: 1fr;} }
.fi-label{display:flex; align-items:center; gap:10px; font-weight:600; margin-bottom:6px}
.fi-ico{display:grid; place-items:center; width:28px; height:28px; border-radius:10px}
.fi-ico svg{width:16px; height:16px; stroke:white; fill:none; stroke-width:2}
.req{color:#ef4444; margin-left:4px}
.fi-note{margin-left:8px; font-weight:500; color:var(--muted); font-size:.9rem}

.of-form input[type="text"],
.of-form input[type="date"],
.of-form input[type="file"],
.of-form select,
.of-form textarea{
  width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:transparent; color:var(--text);
}
.of-form textarea{min-height:220px}
.of-form select[multiple]{min-height:140px}
.of-form input:focus, .of-form select:focus, .of-form textarea:focus{
  border-color:var(--ring); box-shadow:0 0 0 3px rgba(59,130,246,.15); outline:0;
}
.fi-err{margin-top:6px; color:#b91c1c; font-weight:600}
.errorlist{list-style:none; padding:0; margin:.5rem 0; color:#b91c1c}

.fi-icon-input{position:relative}
.fi-input-ico{position:absolute; right:10px; top:50%; transform:translateY(-50%); color:var(--muted)}
.fi-input-ico svg{width:18px; height:18px}

.dropbox{
  border:1.5px dashed var(--border); border-radius:12px; padding:18px; text-align:center; cursor:pointer;
  background:linear-gradient(180deg, rgba(148,163,184,.08), transparent);
  display:grid; place-items:center; gap:6px; color:var(--muted)
}
.dropbox:hover{border-color:var(--ring)}
.dropbox-ico svg{width:22px; height:22px}
.hidden-file input[type="file"]{width:0.1px; height:0.1px; opacity:0; position:absolute; z-index:-1}

.chip{
  display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:.8rem; font-weight:600; margin-left:6px; border:1px solid transparent;
}
.chip[data-variant="B"]{background:rgba(148,163,184,.18); color:#1f2937; border-color:rgba(148,163,184,.35)}
.chip[data-variant="REVIEW"]{background:rgba(139,92,246,.12); color:#5b21b6; border-color:rgba(139,92,246,.35)}
.chip[data-variant="FINAL"]{background:rgba(99,102,241,.12); color:#3730a3; border-color:rgba(99,102,241,.35)}
.chip[data-variant="SENT"]{background:rgba(34,197,94,.12); color:#166534; border-color:rgba(34,197,94,.35)}

.of-actions{
  position:sticky; bottom:8px; display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; padding-top:14px; margin-top:18px; background:linear-gradient(180deg, transparent, var(--bg) 45%);
}
</style>

<!-- ================== SCRIPT (inline) ================== -->
<script>
  /* Tanggal & jam Tetun, aman DOMContentLoaded + interval */
  (function () {
    const TETUN_DAYS = ["Domingu","Segunda","Tersa","Kuarta","Kinta","Sesta","Sabadu"];
    const TETUN_MONTHS = ["Janeiru","Fevereiru","Marsu","Abril","Maiu","Junyu","Julhu","Agostu","Setembru","Outubru","Novembru","Dezembru"];
  
    function fmtTetun(d = new Date()) {
      const dayName   = TETUN_DAYS[d.getDay()];
      const dd        = String(d.getDate()).padStart(2, "0");
      const monthName = TETUN_MONTHS[d.getMonth()];
      const yyyy      = d.getFullYear();
  
      const time = new Intl.DateTimeFormat("en-GB", { hour: "2-digit", minute: "2-digit" })
            .format(d)
            .replace(":", "."); 
  
      return `${dayName}, ${dd} ${monthName} ${yyyy} ,${time}`;
    }
  
    function renderTetunNow() {
      const el = document.getElementById("of-now");
      if (el) el.textContent = fmtTetun();
    }
  
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", renderTetunNow);
    } else {
      renderTetunNow();
    }
    setInterval(renderTetunNow, 30000);
  })();
  </script>  

<script src="https://unpkg.com/vue@3.4.29/dist/vue.global.prod.js"></script>
<script>
const app = Vue.createApp({
  data(){ return {
    dark:false,
    subjectCount: 0,
    bodyCount: {chars:0, words:0},
    attachmentsCount: '',
    signedName: '',
    tplText: '',
    statusChip: {label:'DRAFT', variant:'B'}
  }},
  mounted(){
    this.dark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

    // subject
    const subj = document.getElementById('{{ form.subject.auto_id|default_if_none:"" }}');
    if(subj){
      const update = ()=> this.subjectCount = (subj.value||'').length;
      subj.addEventListener('input', update); update();
    }

    // body count
    const body = document.getElementById('{{ form.body.auto_id|default_if_none:"" }}');
    if(body){
      const update = ()=>{
        const t = (body.value||'');
        this.bodyCount.chars = t.length;
        this.bodyCount.words = (t.trim()? t.trim().split(/\s+/).length : 0);
      };
      body.addEventListener('input', update); update();
    }

    // attachments count (multiple select)
    const att = document.getElementById('{{ form.attachments.auto_id|default_if_none:"" }}');
    if(att){
      const fn = ()=>{
        const n = Array.from(att.options||[]).filter(o=>o.selected).length;
        this.attachmentsCount = n ? `${n} selected` : '0 selected';
      };
      att.addEventListener('change', fn); fn();
    }

    // template_type text
    const tpl = document.getElementById('{{ form.template_type.auto_id|default_if_none:"" }}');
    if(tpl){
      const fn = ()=> this.tplText = tpl.options[tpl.selectedIndex]?.text || '';
      tpl.addEventListener('change', fn); fn();
    }

    // status chip (if exists)
    const st = document.getElementById('{{ form.status.auto_id|default_if_none:"" }}');
    if(st){
      const apply = ()=>{
        const val = st.value || 'DRAFT';
        const map = {
          DRAFT: {label:'DRAFT', variant:'B'},
          REVIEW:{label:'REVIEW', variant:'REVIEW'},
          FINAL: {label:'FINAL', variant:'FINAL'},
          SENT:  {label:'SENT',  variant:'SENT'},
        };
        this.statusChip = map[val] || {label:val, variant:'B'};
      };
      st.addEventListener('change', apply); apply();
    }

    // signed pdf
    const spdf = document.getElementById('{{ form.signed_pdf.auto_id|default_if_none:"" }}');
    if(spdf){
      spdf.addEventListener('change', ()=> this.signedName = spdf.files?.[0]?.name || '');
    }
  },
  methods:{
    onDropPdf(e, inputId){
      const f = e.dataTransfer.files?.[0];
      if(!f) return;
      if(f.type !== 'application/pdf'){ alert('Favor hatama file PDF.'); return; }
      const input = document.getElementById(inputId);
      const dt = new DataTransfer(); dt.items.add(f);
      input.files = dt.files; this.signedName = f.name;
    },
    focusRealInput(id){ document.getElementById(id)?.click(); }
  }
});
app.mount('#outgoing-form-app');
</script>
{% endblock %}

